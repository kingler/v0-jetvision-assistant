# UAT Instructions: ONEK-140

**Issue**: [ONEK-140] Integrate Gmail MCP with Email Service (Production Ready)
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-140-integrate-gmail-mcp-with-email-service-production-ready`
**Status**: In Progress
**Priority**: Urgent
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This issue replaces the mock email implementation in `lib/services/email-service.ts` with a real Gmail MCP client wrapper (`lib/mcp/gmail-client.ts`) so that proposal emails actually send to clients in production. The existing Gmail MCP server at `mcp-servers/gmail-mcp-server/` is already implemented with 35 passing tests; this issue wires the email service to use it. A `USE_MOCK_EMAIL` environment variable preserves mock mode for development and testing.

---

## Acceptance Criteria

### AC-1: Gmail MCP Client Wrapper Created

**Given** the Gmail MCP server is running at `mcp-servers/gmail-mcp-server/`
**When** the application imports `lib/mcp/gmail-client.ts`
**Then** it provides a `getGmailMCPClient()` function that connects to the Gmail MCP server and exposes a `sendEmail` method with `to`, `subject`, `body_html`, and `attachments` parameters

### AC-2: Email Service Routes Through Gmail MCP in Production Mode

**Given** `USE_MOCK_EMAIL` is not set or set to `false` in `.env.local`
**When** a user triggers "Send Proposal" from the chat interface for a quote
**Then** the proposal email is sent via the Gmail MCP server, arrives in the recipient's inbox with the PDF attachment, and appears in the sender's Gmail "Sent" folder

### AC-3: Mock Mode Preserved for Development/Testing

**Given** `USE_MOCK_EMAIL=true` is set in `.env.local`
**When** a user triggers "Send Proposal" from the chat interface
**Then** the email is logged to the console (mock behavior) and no real email is sent via Gmail

### AC-4: Error Handling for Gmail API Failures

**Given** the Gmail MCP server is configured but encounters an error (invalid recipient, auth failure, quota exceeded)
**When** the email service attempts to send
**Then** a descriptive error message is returned to the user in the chat interface without crashing the application

### AC-5: Existing Proposal Workflow Unchanged (Regression)

**Given** the email service integration is complete
**When** a user performs the full proposal workflow (select quote, generate proposal PDF, preview email, adjust margin, send)
**Then** all existing UI components (`rfq-flight-card.tsx`, `send-proposal-step.tsx`, email preview dialog) function identically to before the integration

---

## Test Steps

### Test 1: Gmail MCP Client Wrapper (Maps to AC-1)

1. Verify the file `lib/mcp/gmail-client.ts` exists
   - **Expected**: File exists and exports `getGmailMCPClient()` function
2. Check that the Gmail MCP server starts without errors: `npm run dev:mcp`
   - **Expected**: MCP servers start, Gmail server connects successfully
3. Inspect the client wrapper code for proper MCP connection setup
   - **Expected**: Uses `@modelcontextprotocol/sdk` or equivalent to connect to the Gmail server

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Production Email Sending (Maps to AC-2)

1. Configure Gmail credentials in `.env.local` (OAuth or service account)
2. Set `USE_MOCK_EMAIL=false` (or remove the variable entirely)
3. Start the application: `npm run dev`
4. Open the chat interface and navigate to a session with operator quotes
5. Click "Generate Proposal" on a quote, then proceed to "Send Proposal"
6. Enter a valid recipient email address and send
   - **Expected**: Email is sent — check the recipient's inbox for the proposal email with PDF attachment
7. Open the sender's Gmail account and check the "Sent" folder
   - **Expected**: The sent proposal email appears with correct subject, body, and PDF attachment

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Mock Mode Fallback (Maps to AC-3)

1. Set `USE_MOCK_EMAIL=true` in `.env.local`
2. Restart the app: `npm run dev`
3. Open the chat interface and trigger "Send Proposal" for a quote
4. Open browser DevTools console before sending
5. Click send
   - **Expected**: Console shows mock email output (recipient, subject, body preview)
   - **Expected**: No real email is sent — check recipient inbox to confirm
6. The chat UI shows a success confirmation as if the email was sent
   - **Expected**: UI behaves the same as production mode (success message)

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Error Handling (Maps to AC-4)

1. Set `USE_MOCK_EMAIL=false` in `.env.local`
2. Start the app: `npm run dev`
3. Attempt to send a proposal to an invalid email address (e.g., `not-an-email`)
   - **Expected**: Error message displayed in the chat or proposal dialog (e.g., "Invalid recipient address")
4. If possible, temporarily invalidate Gmail OAuth credentials and attempt to send
   - **Expected**: Error message about authentication failure, no crash
5. Verify the app remains functional after the error
   - **Expected**: Can navigate, start new requests, and retry sending

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: Full Proposal Workflow Regression (Maps to AC-5)

1. Start the app with production email settings (`USE_MOCK_EMAIL=false`)
2. Create a new flight request in the chat
3. Wait for operator quotes to arrive (or use an existing session with quotes)
4. Click "Generate Proposal" on a quote
   - **Expected**: Proposal PDF generates correctly
5. Preview the email — adjust the margin slider
   - **Expected**: Prices update in real-time in the preview
6. Send the proposal
   - **Expected**: Success confirmation in the chat
7. Check the sidebar for status update
   - **Expected**: Session status reflects "Proposal Sent" (not stuck on "Pending")

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000`
- **Branch**: `kinglerbercy/onek-140-integrate-gmail-mcp-with-email-service-production-ready`
- **Setup**: `npm run dev` (starts app + MCP servers including Gmail)

### Test Data

- Gmail OAuth credentials configured in `.env.local`
- A test recipient email address for production send verification
- An existing chat session with operator quotes, or create a new flight request

### Pre-Test Setup

1. Ensure Gmail MCP server credentials are configured
2. Verify MCP servers start: `npm run dev:mcp` — look for Gmail server connection
3. Have access to the sender's Gmail account to verify "Sent" folder

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed — ready for production
- [ ] Issues found — see notes above
- [ ] Blocked — requires {description}

---

*Generated by `/uat_instructions ONEK-140` on 2026-02-08*
