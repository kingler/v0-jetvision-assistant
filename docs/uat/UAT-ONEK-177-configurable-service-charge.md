# UAT Instructions: ONEK-177

**Issue**: [ONEK-177](https://linear.app/designthru-ai/issue/ONEK-177) ENHANCEMENT: Configurable Jetvision service charge %, client-facing proposal shows total only
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-177-enhancement-configurable-jetvision-service-charge-client` (merged to `main` via PRs #96, #97)
**Status**: Done
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This enhancement adds configurable service charge percentage selection during proposal generation. Users can choose from preset buttons (8%, 10%, 20%) or enter a custom percentage. The internal UI displays operator cost, service cost, and total cost breakdowns, while the client-facing proposal PDF shows only the total cost -- the Jetvision service charge is never exposed to end clients. Additionally, margin selection and email preview cards now persist across chat switches and browser refreshes.

---

## Acceptance Criteria

### AC-1: Service Charge Preset Selection

**Given** a user is in the proposal generation flow and the customer selection dialog is open
**When** the user clicks one of the preset service charge buttons (8%, 10%, or 20%)
**Then** the margin percentage is set to the selected value, the dialog defaults to 10% on first open, and the margin value flows correctly into the proposal generation pipeline

### AC-2: Custom Service Charge Entry

**Given** a user is in the customer selection dialog and wants a non-preset margin
**When** the user clicks "Custom" and enters a custom percentage value (e.g., 15%)
**Then** the custom value is accepted and applied to the proposal calculation identically to preset values

### AC-3: Internal Cost Breakdown Display

**Given** a proposal has been generated with a selected service charge percentage
**When** the internal UI renders the SendProposalStep card
**Then** the card shows three distinct cost lines: operator cost, Jetvision service cost, and total cost, and all values update correctly when the percentage is changed

### AC-4: Client-Facing Proposal Hides Service Fee

**Given** a proposal PDF has been generated for a client
**When** the client-facing PDF is viewed or downloaded
**Then** the PDF contains only the total cost and does NOT display "Jetvision Service Fee", "Charter Cost", or any service charge breakdown lines

### AC-5: Margin Selection Card Persists in Chat

**Given** a user has selected a customer and margin percentage in the proposal flow
**When** the user switches to a different chat session and switches back, or refreshes the browser
**Then** the margin selection summary card remains visible in the chat thread showing the customer name, company, margin percentage, and timestamp

### AC-6: Email Preview Card Persists Across Refreshes

**Given** an email preview card is displayed in the chat after proposal generation
**When** the user refreshes the browser or switches chat sessions and returns
**Then** the email preview card is restored from the database with correct content and approval status

### AC-7: Regression -- One-Way Proposals Unaffected

**Given** a one-way trip with a single quote
**When** the user generates a proposal with a 10% margin
**Then** the proposal is generated successfully with correct pricing, identical behavior to before this feature

---

## Test Steps

### Test 1: Preset Buttons and Default Selection (Maps to AC-1)

1. Open the app at `http://localhost:3000` and navigate to the chat interface
2. Start or use a flight request workflow with received operator quotes
3. Begin the proposal generation flow
4. When the customer selection dialog opens, observe the margin selection area
   - **Expected**: Three preset buttons labeled "8%", "10%", "20%" are visible, plus a "Custom" option
5. Verify the default selection is 10%
   - **Expected**: The 10% button is visually selected/highlighted on dialog open
6. Click the "8%" button
   - **Expected**: The margin updates to 8% and any cost breakdown recalculates
7. Click the "20%" button
   - **Expected**: The margin updates to 20% and cost breakdown recalculates

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Custom Percentage Entry (Maps to AC-2)

1. In the customer selection dialog, click the "Custom" option
   - **Expected**: A text input field appears for entering a custom percentage
2. Enter "15" in the custom input
   - **Expected**: The margin is set to 15% and cost breakdown updates accordingly
3. Enter "0" in the custom input
   - **Expected**: The system handles 0% gracefully (total cost equals operator cost)
4. Proceed with proposal generation using the custom value
   - **Expected**: The proposal generates successfully with the custom margin applied

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Internal Cost Breakdown (Maps to AC-3)

1. Generate a proposal with a 10% service charge
2. Observe the SendProposalStep card in the internal chat UI
   - **Expected**: Three cost lines visible: "Operator Cost", "Service Cost", and "Total Cost"
3. Verify arithmetic: Service Cost = Operator Cost x (margin% / 100)
   - **Expected**: For $50,000 operator cost at 10%, service cost = $5,000, total = $55,000
4. Change the margin to 20% and regenerate
   - **Expected**: Service cost and total cost update correctly

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Client-Facing PDF Verification (Maps to AC-4)

1. Generate a proposal with any service charge percentage
2. Download or preview the client-facing PDF
3. Search the PDF text for "Jetvision Service Fee"
   - **Expected**: NOT found in the PDF
4. Search the PDF text for "Charter Cost"
   - **Expected**: NOT found in the PDF
5. Verify the PDF contains only the total cost amount
   - **Expected**: One price line showing the total cost, with no service charge breakdown visible

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: Margin Selection Card Persistence (Maps to AC-5)

1. Complete the customer and margin selection step (select a customer, choose 10% margin)
2. Observe the margin selection summary card in the chat
   - **Expected**: Card shows customer name, company, margin %, and timestamp
3. Switch to a different chat session via the sidebar
4. Switch back to the original chat session
   - **Expected**: The margin selection summary card is still visible with correct data
5. Refresh the browser (Cmd+R / Ctrl+R)
   - **Expected**: After page reload, the margin selection card reappears in the correct position

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 6: Email Preview Persistence (Maps to AC-6)

1. Complete the proposal flow through to the email preview step
2. Observe the email preview card with recipient, subject, and body
3. Without sending, refresh the browser
   - **Expected**: The email preview card reappears after reload with identical content
4. Switch to another chat session and switch back
   - **Expected**: The email preview card is restored with correct approval status

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 7: One-Way Proposal Regression (Maps to AC-7)

1. Open a chat session with a one-way trip and quotes
2. Generate a proposal with 10% margin
   - **Expected**: Proposal generates successfully with correct single-leg pricing
3. Verify no "Return" section is displayed
   - **Expected**: Only outbound leg is shown

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000` (development) or staging URL
- **Branch**: `main` (commits `a4eac21`, `018cbd0`, `6892c44`)
- **Setup**: `npm install && npm run dev`

### Test Data

- Use any active chat session with trip data and operator quotes
- For PDF verification, generate a downloadable proposal and inspect the output
- Recommended airports: KTEB (Teterboro), KVNY (Van Nuys), KLAX (Los Angeles)
- Have at least one test customer in the CRM for customer selection

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure MCP servers are configured (Avinode, Supabase, Gmail)
3. Have at least one active trip with received quotes for proposal generation testing

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-177` on 2026-02-08*
