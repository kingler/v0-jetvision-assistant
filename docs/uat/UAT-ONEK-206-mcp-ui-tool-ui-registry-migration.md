# UAT Instructions: ONEK-206

**Issue**: [ONEK-206] MCP UI-Inspired Tool UI Registry Migration
**Date Generated**: 2026-02-08
**Branch**: `feat/mcp-ui-tool-registry` (squash-merged to `main` as `721ee8a`)
**Status**: Done
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This issue migrates the tightly coupled chat rendering pipeline to a declarative Tool UI Registry pattern inspired by MCP UI. Instead of threading 50+ boolean props through a 756-line `AgentMessage` component and a 275-line switch statement, a new `ToolUIRenderer` looks up tool names in `TOOL_UI_REGISTRY` and renders existing React components directly with extracted props. The entire new path is feature-flagged via `NEXT_PUBLIC_ENABLE_MCP_UI` and includes airport ICAO enrichment and an error boundary for malformed tool data.

---

## Acceptance Criteria

### AC-1: Declarative Tool UI Rendering (Flag ON)

**Given** the feature flag `NEXT_PUBLIC_ENABLE_MCP_UI=true` is set and the app is rebuilt
**When** a user submits a flight request (e.g., "I need a flight from KTEB to KVNY") and the agent executes `create_trip`
**Then** the `AgentMessageV2` component renders the `TripCreatedUI` composite, which displays a `TripSummaryCard` with enriched airport names (e.g., "KTEB, Teterboro") and clickable "Open in Avinode" deep link buttons

### AC-2: Feature Flag OFF — No Regressions in Legacy Path

**Given** the feature flag `NEXT_PUBLIC_ENABLE_MCP_UI` is not set or set to `false` (default)
**When** the user performs any existing chat workflow (flight request, RFQ quotes, proposals)
**Then** all existing UI components render identically to the pre-migration behavior — `TripSummaryCard`, `AvinodeDeepLinks`, RFQ flight cards, and proposal cards all appear correctly with no visual or functional regressions

### AC-3: Error Boundary Handles Malformed Tool Data

**Given** the feature flag is ON and the agent returns a tool result with malformed or missing data
**When** `ToolUIRenderer` attempts to render the tool's component
**Then** the UI displays a graceful fallback message ("Unable to display {toolName} result") instead of crashing the entire chat interface

### AC-4: Airport ICAO Enrichment

**Given** the feature flag is ON and a `create_trip` tool result contains bare ICAO codes (e.g., `"KTEB"`) without city/name metadata
**When** the `TripCreatedUI` composite renders the `TripSummaryCard`
**Then** airport codes are enriched from the airport database, displaying full names (e.g., "KTEB, Teterboro Airport") with no trailing commas or empty city fields

### AC-5: Text-Only Tools Render as Markdown (Regression)

**Given** the feature flag is ON and the agent executes a text-only tool (e.g., `cancel_trip` or `send_trip_message`)
**When** the tool result is not mapped in `TOOL_UI_REGISTRY` (returns `null`)
**Then** the result renders as markdown text in the chat, consistent with the legacy rendering behavior

---

## Test Steps

### Test 1: Declarative Tool UI Rendering (Maps to AC-1)

1. Set the environment variable: add `NEXT_PUBLIC_ENABLE_MCP_UI=true` to `.env.local`
2. Rebuild the app: `npm run build && npm start`
3. Open the app in a browser and navigate to the chat interface
4. Create a new chat session or use an existing one
5. Type a flight request: "I need a flight from Teterboro to Van Nuys on March 15"
6. Wait for the agent to process and call `create_trip`
7. Observe the chat response
   - **Expected**: A `TripSummaryCard` appears showing the route with enriched airport names (e.g., "KTEB, Teterboro" and "KVNY, Van Nuys")
8. Look for the "Open in Avinode" button below the trip summary
   - **Expected**: A clickable deep link button is rendered via `AvinodeDeepLinks`
9. Open browser DevTools console and check for errors
   - **Expected**: Zero console errors related to MCP UI rendering

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Feature Flag OFF — No Regressions (Maps to AC-2)

1. Ensure `NEXT_PUBLIC_ENABLE_MCP_UI` is not set or set to `false` in `.env.local`
2. Rebuild the app: `npm run build && npm start`
3. Open the chat interface
4. Submit a flight request and wait for the agent response
   - **Expected**: `TripSummaryCard` renders with full airport info and deep link buttons (using legacy `AgentMessage` path)
5. Navigate to a session that has RFQ quotes from operators
   - **Expected**: RFQ flight cards render with operator name, aircraft, and pricing — no visual differences from before the migration
6. Open a session with a sent proposal
   - **Expected**: Proposal cards and email preview render correctly
7. Check browser console for errors
   - **Expected**: Zero console errors

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Error Boundary (Maps to AC-3)

1. Set `NEXT_PUBLIC_ENABLE_MCP_UI=true` in `.env.local` and rebuild
2. Open browser DevTools console
3. In the console, verify that the `ToolUIErrorBoundary` class exists on the `ToolUIRenderer` component source
4. Simulate a malformed tool result scenario (if possible via a test trip or by examining the error boundary code in `components/mcp-ui/ToolUIRenderer.tsx`)
   - **Expected**: If `extractProps()` throws, the chat displays "Unable to display {toolName} result" instead of a blank screen or crash
5. Verify the rest of the chat remains functional after the error
   - **Expected**: Other messages and tool UIs in the same session continue to render normally

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Airport ICAO Enrichment (Maps to AC-4)

1. Set `NEXT_PUBLIC_ENABLE_MCP_UI=true` in `.env.local` and rebuild
2. Submit a flight request using ICAO codes: "Flight from KTEB to KLAX"
3. Wait for the `create_trip` tool to complete
4. Inspect the `TripSummaryCard` in the chat
   - **Expected**: Departure shows "KTEB, Teterboro Airport" (not "KTEB," with trailing comma)
   - **Expected**: Arrival shows "KLAX, Los Angeles International Airport" (not "KLAX,")
5. Try a less common airport code (e.g., "KSDL" for Scottsdale)
   - **Expected**: Airport name is enriched from the database, or displays the ICAO code cleanly without trailing punctuation

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: Text-Only Tools Render as Markdown (Maps to AC-5)

1. Set `NEXT_PUBLIC_ENABLE_MCP_UI=true` in `.env.local` and rebuild
2. In a chat session with an active trip, ask the agent to send a message to operators (e.g., "Send a message to the operators asking about availability")
3. Wait for the `send_trip_message` tool to execute
   - **Expected**: The result renders as plain markdown text in the chat bubble, not as a specialized card
4. Ask the agent to cancel a trip (if a test trip is available)
   - **Expected**: The `cancel_trip` result also renders as markdown text
5. Verify no errors in the console
   - **Expected**: No "registry not found" or render errors for unmapped tools

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000` (development) or staging URL
- **Branch**: `main` (merged via `721ee8a`)
- **Setup**:
  - For flag ON tests: Add `NEXT_PUBLIC_ENABLE_MCP_UI=true` to `.env.local`, then `npm run build && npm start`
  - For flag OFF tests: Remove or set `NEXT_PUBLIC_ENABLE_MCP_UI=false`, then `npm run build && npm start`

### Test Data

- Use any active chat session with trip data, or create a new flight request
- Recommended airports for enrichment testing: KTEB, KVNY, KLAX, KSDL
- For RFQ/quote testing, use a session with existing operator quotes (e.g., session with Trip ID visible in sidebar)

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure MCP servers are configured (Avinode, Supabase, Gmail) for full workflow testing
3. Clear browser cache before switching between flag ON/OFF states to avoid stale CSS or JS bundles

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed — ready for production (enable flag permanently)
- [ ] Issues found — see notes above
- [ ] Blocked — requires {description}

---

*Generated by `/uat_instructions ONEK-206` on 2026-02-08*
