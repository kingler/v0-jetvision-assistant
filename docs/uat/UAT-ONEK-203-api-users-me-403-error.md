# UAT Instructions: ONEK-203

**Issue**: [ONEK-203] /api/users/me endpoint returns 403 Forbidden
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-203-bug-apiusersme-endpoint-returns-403-forbidden`
**Status**: Done
**Priority**: Low
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This bug fix resolves the `/api/users/me` endpoint returning 403 Forbidden errors on every page load. The endpoint was being called twice during page load, and both requests returned 403, indicating a Clerk authentication configuration issue or missing middleware. While the app still functioned normally without this endpoint, the 403 errors generated unnecessary noise in network logs and could mask real authentication failures. The fix ensures the endpoint correctly validates and returns user data when the user is authenticated.

---

## Acceptance Criteria

### AC-1: /api/users/me Returns 200 OK with Valid User Data

**Given** the user is authenticated via Clerk and the page has loaded
**When** the `/api/users/me` endpoint is called
**Then** the endpoint returns HTTP 200 OK with a JSON response containing the authenticated user's data (e.g., user ID, name, email)

### AC-2: No 403 Errors on Page Load

**Given** the user is authenticated and navigates to any page in the application
**When** the page finishes loading (observed via browser DevTools Network tab)
**Then** zero requests to `/api/users/me` return 403 Forbidden status

### AC-3: Unauthenticated Requests Return Appropriate Error

**Given** the user is not authenticated (logged out or session expired)
**When** a request is made to `/api/users/me`
**Then** the endpoint returns HTTP 401 Unauthorized (not 403 Forbidden), indicating authentication is required

### AC-4: No Application Functionality Regression

**Given** the `/api/users/me` fix is deployed
**When** the user performs normal application workflows (chat, flight requests, proposals)
**Then** all application features continue to work correctly with no new errors or behavioral changes

---

## Test Steps

### Test 1: Successful User Data Retrieval (Maps to AC-1)

1. Open the application at `http://localhost:3001`
2. Log in with a valid Clerk account
3. Open browser DevTools (F12) and navigate to the Network tab
4. Filter requests by `/api/users/me`
5. Reload the page
6. Inspect the response for `/api/users/me`
   - **Expected**: HTTP status 200 OK
7. Click on the response and inspect the JSON body
   - **Expected**: Response contains user data fields (e.g., `id`, `email`, `name` or similar user profile fields)
8. Verify the response contains the correct user information matching the logged-in account
   - **Expected**: Data matches the authenticated user

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: No 403 Errors on Page Load (Maps to AC-2)

1. Open browser DevTools Network tab
2. Clear the network log
3. Reload the page
4. Wait for full page load
5. Filter by `/api/users/me` OR filter by status code `403`
   - **Expected**: Zero requests return 403 Forbidden
6. Check the Console tab for any auth-related error messages
   - **Expected**: No console errors related to authentication or 403 status
7. Navigate to 2-3 different pages/routes within the app
   - **Expected**: No 403 errors on any navigation

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Unauthenticated Request Handling (Maps to AC-3)

1. Log out of the application (or open an incognito window without logging in)
2. Open DevTools Network tab
3. Attempt to access the app or directly call `/api/users/me` via the browser address bar
4. Inspect the response
   - **Expected**: HTTP 401 Unauthorized (NOT 403 Forbidden)
5. Verify the response body contains a meaningful error message
   - **Expected**: Error message indicates authentication is required (e.g., "Unauthorized" or "Authentication required")

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Application Functionality Regression (Maps to AC-4)

1. Log in and navigate through the application
2. Open the chat interface and interact with an existing session
   - **Expected**: Messages load and display correctly
3. Create a new flight request
   - **Expected**: Agent responds and creates trip normally
4. Check the sidebar for session list
   - **Expected**: All sessions display with correct statuses and routes
5. Verify user-specific features (e.g., user name display in header/profile)
   - **Expected**: User name and profile data display correctly throughout the app
6. Check browser console for any new errors
   - **Expected**: No new errors introduced by the fix

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3001` (development) or staging URL
- **Branch**: `main` (merged)
- **Setup**: `npm install && npm run dev`
- **Authentication**: Clerk account with valid credentials

### Test Data

- **Authenticated user**: Any valid Clerk account configured for the app
- **Unauthenticated test**: Use incognito window or log out
- **Network monitoring**: Chrome DevTools Network tab with XHR/Fetch filter

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure Clerk environment variables are set in `.env.local` (`NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`, `CLERK_SECRET_KEY`)
3. Start the development server: `npm run dev`
4. Have valid Clerk login credentials ready

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-203` on 2026-02-08*
