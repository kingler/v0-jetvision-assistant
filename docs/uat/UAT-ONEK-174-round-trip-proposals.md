# UAT Instructions: ONEK-174

**Issue**: [ONEK-174](https://linear.app/designthru-ai/issue/ONEK-174) BUG: Round-trip proposals show only one leg; include both outbound + return
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-174-bug-round-trip-proposals-show-only-one-leg-include-both` (merged to `main` via PRs #90, #91, #92, #93)
**Status**: Done
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This bug fix ensures that round-trip flight proposals include both the outbound and return legs. Previously, the proposal generation pipeline only rendered the outbound leg even when the conversation layer captured return date and round-trip type. The fix spans the full stack: data model extensions (legType, legSequence), proposal generator updates, PDF template rendering with round-trip layout, API validation, and UI component updates with outbound/return badges.

---

## Acceptance Criteria

### AC-1: Round-Trip Proposal Includes Both Legs

**Given** a round-trip booking with outbound (e.g., KTEB to KVNY) and return (KVNY to KTEB) flights
**When** the user generates a proposal
**Then** the proposal includes exactly two legs: outbound and return, each with correct airports, dates, times, and flight details

### AC-2: UI Displays Both Legs with Clear Labels

**Given** a generated round-trip proposal in the chat UI
**When** the user views the proposal card and sidebar
**Then** both legs are displayed with clear "Outbound" and "Return" labels/badges, the header shows round-trip indicators, and legs are in correct chronological order

### AC-3: Total Price Accuracy for Round-Trip

**Given** a round-trip proposal with both legs
**When** the user views the total price
**Then** the total equals the sum of both leg prices (or the operator's combined quote total) and is consistent throughout the UI

### AC-4: PDF Renders Both Legs

**Given** a round-trip proposal has been generated
**When** the user downloads or previews the PDF
**Then** the PDF shows both outbound and return legs with all flight details in a round-trip layout

### AC-5: Incomplete Data Fails Gracefully

**Given** a round-trip request where the provider/API returns incomplete data (missing one leg)
**When** proposal creation is attempted
**Then** the proposal creation fails with a clear user-safe error message, and logs include correlation details for debugging

### AC-6: Regression -- One-Way Proposals Unaffected

**Given** a one-way trip with a single leg
**When** the user generates a proposal
**Then** the proposal shows exactly one leg with correct details and no empty "Return" section

---

## Test Steps

### Test 1: Both Legs in Round-Trip Proposal (Maps to AC-1, AC-2)

1. Open a chat session with a round-trip request (e.g., "KTEB to KVNY on March 15, return March 18")
2. Ensure quotes have been received for the round-trip
3. Generate a proposal
4. Observe the proposal card in the chat
   - **Expected**: Two sections visible -- "Outbound" and "Return" with distinct badges
5. Verify outbound leg details
   - **Expected**: Departure KTEB, arrival KVNY, date March 15 with correct times
6. Verify return leg details
   - **Expected**: Departure KVNY, arrival KTEB, date March 18 with correct times
7. Check the sidebar and header for round-trip indicators
   - **Expected**: Round-trip badge/indicator is displayed in sidebar and Step 1 card

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Total Price Accuracy (Maps to AC-3)

1. View the generated round-trip proposal
2. Note the outbound leg price and return leg price (if itemized)
3. Verify the total price calculation
   - **Expected**: Total price = outbound price + return price, or matches the operator's combined quote total
4. Compare with the original operator quote total
   - **Expected**: Totals match across the quote card, proposal card, and PDF

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: PDF Output with Both Legs (Maps to AC-4)

1. From the proposal view, click "Download PDF" or "Preview"
2. Open the PDF and inspect the content
   - **Expected**: PDF includes both outbound and return leg sections with round-trip layout
3. Verify each leg shows airports, dates, times, aircraft type, and price
   - **Expected**: All details are present and correctly formatted for both legs
4. Verify the total price in the PDF
   - **Expected**: Total cost is correct and no service charge breakdown is visible

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: One-Way Proposal Regression (Maps to AC-6)

1. Open a chat session with a one-way trip (e.g., "KTEB to KLAX on March 20, one way")
2. Generate a proposal
   - **Expected**: Proposal shows exactly one leg with correct details
3. Verify no "Return" section appears
   - **Expected**: No empty return section or stale return data
4. Download the PDF
   - **Expected**: PDF shows single-leg layout

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: Error Handling for Incomplete Data (Maps to AC-5)

1. If possible, simulate a scenario where the return leg data is missing from the API response
2. Attempt to generate a round-trip proposal
   - **Expected**: A clear error message is displayed to the user indicating incomplete flight data
3. Check application logs
   - **Expected**: Logs contain correlation details (trip ID, request ID) for debugging

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000` (development) or staging URL
- **Branch**: `main` (commits `c493f4f`, `7a589f8`, `2019648`, `90531c6`, `f889a42`)
- **Setup**: `npm install && npm run dev`

### Test Data

- Round-trip session: Use airports KTEB and KVNY with outbound + return dates
- One-way session: Use any single-leg trip for regression testing
- Ensure operator quotes have been received for both trip types

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure MCP servers are configured (Avinode, Supabase)
3. Have at least one round-trip session with operator quotes
4. Have at least one one-way session with operator quotes for regression

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-174` on 2026-02-08*
