# UAT Instructions: ONEK-204

**Issue**: [ONEK-204] App eagerly loads messages for ALL sessions on page load (281 requests)
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-204-perf-app-eagerly-loads-messages-for-all-sessions-on-page` (commit `4d204be`)
**Status**: Done
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This performance fix addresses the application eagerly loading messages for all 30+ chat sessions on initial page load, resulting in approximately 281 API requests to `/api/chat-sessions/messages`. This caused slow initial page loads, unnecessary bandwidth consumption, and excessive Supabase API calls that scaled poorly as users accumulated more sessions. The fix implements lazy loading -- messages are only fetched when a session is clicked/opened by the user, with previously loaded sessions cached in memory to avoid redundant fetches.

---

## Acceptance Criteria

### AC-1: Messages Load Only When Session Is Selected (Lazy Loading)

**Given** the user loads the application with 30+ chat sessions in the sidebar
**When** the initial page load completes
**Then** only the active/visible session's messages are fetched; no `/api/chat-sessions/messages` requests are fired for other sessions until they are explicitly clicked

### AC-2: Network Request Count Is Drastically Reduced on Page Load

**Given** the user has 30+ chat sessions and reloads the page
**When** the page finishes loading (observed via browser DevTools Network tab)
**Then** the total number of API requests to `/api/chat-sessions/messages` on initial load is 1 or fewer (down from ~281), with a measurable improvement in page load time

### AC-3: Clicking a Session Loads Its Messages On Demand

**Given** the page has loaded and the user sees the session list in the sidebar
**When** the user clicks on a different session that has not yet been opened
**Then** the messages for that session are fetched via a single API request, a loading indicator is shown during the fetch, and the messages render correctly once loaded

### AC-4: Previously Loaded Sessions Use Cached Messages

**Given** the user has already opened and viewed session A, then switched to session B
**When** the user clicks back to session A
**Then** session A's messages display immediately from cache without triggering a new API request (verified via Network tab)

### AC-5: No Regression in Message Display or Chat Functionality

**Given** messages are lazy-loaded for a session
**When** the user interacts with the chat (sends messages, receives agent responses, views tool UIs)
**Then** all messages render correctly, new messages appear in real-time, and tool UI cards (TripSummaryCard, RFQ cards, proposals) display properly -- identical behavior to the pre-fix eager loading

---

## Test Steps

### Test 1: Lazy Loading on Page Load (Maps to AC-1, AC-2)

1. Open the application at `http://localhost:3001`
2. Before loading, open browser DevTools (F12) and navigate to the Network tab
3. Clear the Network log
4. Reload the page (Cmd+R or F5)
5. Wait for the page to fully load
6. Filter the Network tab by `/api/chat-sessions/messages`
   - **Expected**: At most 1 request for the currently active session, NOT 281+ requests for all sessions
7. Count the total number of XHR/Fetch requests during page load
   - **Expected**: Significantly fewer than the previous ~281 (likely under 20 total API requests)
8. Note the page load time (DOMContentLoaded and Load events in Network tab)
   - **Expected**: Faster page load compared to previous behavior

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: On-Demand Message Loading (Maps to AC-3)

1. After page load, identify a session in the sidebar that is NOT currently active
2. Open DevTools Network tab and clear the log
3. Click on the inactive session
4. Observe the Network tab
   - **Expected**: Exactly 1 new request to `/api/chat-sessions/messages?session_id=<clicked-session-id>`
5. Observe the chat area during loading
   - **Expected**: A loading indicator (spinner or skeleton) appears briefly while messages are fetched
6. After loading completes, verify messages are displayed correctly
   - **Expected**: All messages for the selected session render in the chat area with proper formatting

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Cached Session Switching (Maps to AC-4)

1. Click on Session A and wait for messages to load
2. Click on Session B and wait for messages to load
3. Open DevTools Network tab and clear the log
4. Click back on Session A
5. Check the Network tab
   - **Expected**: No new request to `/api/chat-sessions/messages` -- messages load from cache instantly
6. Verify Session A's messages display correctly from cache
   - **Expected**: All messages, tool UIs, and formatting are intact (no stale or missing data)

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Message Display and Chat Regression (Maps to AC-5)

1. Open a session with existing tool UI cards (TripSummaryCard, RFQ flight cards, proposals)
2. Verify all tool UI components render correctly after lazy loading
   - **Expected**: TripSummaryCards show correct route/dates, RFQ cards show operator/pricing, proposal cards are interactive
3. Send a new message in the chat: "What is the status of my flight request?"
4. Wait for the agent response
   - **Expected**: Agent responds normally, new messages appear in real-time without page refresh
5. Check for any console errors
   - **Expected**: Zero console errors related to message loading, caching, or rendering

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: Scalability Verification (Maps to AC-2)

1. Note the total number of sessions in the sidebar (visible count)
2. Reload the page with Network tab open
3. Count the total requests fired during load
4. Compare against the session count
   - **Expected**: Request count is NOT proportional to session count (should be constant ~1, not N)
5. If possible, verify with a user account that has 50+ sessions
   - **Expected**: Page load performance remains constant regardless of total session count

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3001` (development) or staging URL
- **Branch**: `main` (commit `4d204be` merged)
- **Setup**: `npm install && npm run dev`

### Test Data

- **User account with multiple sessions**: Use any account with 10+ chat sessions for meaningful comparison
- **Session with tool UIs**: CJTQML or any session with visible TripSummaryCard, RFQ cards
- **Benchmark**: Previous behavior was ~281 requests on page load with 30+ sessions

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Start the development server: `npm run dev`
3. Open browser DevTools and familiarize with Network tab filtering
4. Clear browser cache to start with a clean state

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-204` on 2026-02-08*
