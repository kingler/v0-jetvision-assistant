# UAT Instructions: ONEK-190

**Issue**: [ONEK-190](https://linear.app/designthru-ai/issue/ONEK-190) Bug: Chat messages display out of chronological order -- broken timestamp fallback
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-190-bug-chat-messages-display-out-of-chronological-order-broken` (merged to `main` via PR #95)
**Status**: Done
**Priority**: Urgent
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This critical bug fix resolves an issue where chat messages appeared scrambled (out of chronological order) in sessions. The root cause was a `safeParseTimestamp()` fallback that assigned `Date.now()` to persisted messages with invalid timestamps, placing days-old messages at the current time. The fix replaces the `Date.now()` fallback with `new Date(0)` (epoch), introduces a unified `formatMessageTimestamp()` utility that shows date+time for non-today messages and time-only for today's messages, and standardizes timestamp formatting across all message components (AgentMessage, UserMessage, OperatorMessage).

---

## Acceptance Criteria

### AC-1: Messages Display in Chronological Order

**Given** a chat session with messages spanning multiple days
**When** the user opens or navigates to the session
**Then** all messages are displayed in correct chronological order (oldest first, newest last) with no scrambling

### AC-2: Timestamp Display Format -- Today vs. Older

**Given** a chat session containing both today's messages and messages from previous days
**When** the user views the message timestamps
**Then** today's messages show time only (e.g., "2:30 PM") and older messages show date + time (e.g., "Jan 15, 2026 at 2:30 PM")

### AC-3: Invalid Timestamps Handled Gracefully

**Given** a message with an invalid or missing timestamp exists in the database
**When** the chat interface renders that message
**Then** the message sorts to the beginning of the conversation (epoch fallback) and does not appear at the current time, preventing sort order disruption

### AC-4: Consistent Timestamp Format Across Components

**Given** messages rendered by different components (AgentMessage, UserMessage, OperatorMessage)
**When** the user views the chat session
**Then** all message types use the same `formatMessageTimestamp()` format, with no component using a different formatting style

### AC-5: Regression -- New Messages Sort Correctly

**Given** the user sends a new message in an existing session
**When** the message appears in the chat
**Then** the new message appears at the bottom of the thread with a correct "just now" timestamp in the expected format

---

## Test Steps

### Test 1: Chronological Message Order (Maps to AC-1)

1. Open the app and navigate to a chat session that has messages spanning multiple days
2. Scroll through the message history from top to bottom
   - **Expected**: Messages appear in strict chronological order -- oldest at top, newest at bottom
3. Verify no messages from previous days appear at the bottom (mixed with recent messages)
   - **Expected**: No scrambled ordering; days-old messages are in their correct position
4. Check multiple sessions with varying message histories
   - **Expected**: Chronological order is maintained across all sessions

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Timestamp Display Format (Maps to AC-2)

1. Open a session with messages from today AND previous days
2. Observe timestamps on today's messages
   - **Expected**: Format is time-only, e.g., "2:30 PM" (no date prefix)
3. Observe timestamps on messages from previous days
   - **Expected**: Format is date + time, e.g., "Jan 15, 2026 at 2:30 PM"
4. Observe timestamps on messages from yesterday
   - **Expected**: Date + time format is used (not "Yesterday")

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Invalid Timestamp Handling (Maps to AC-3)

1. If possible, identify or create a message with an invalid timestamp in the database
2. Open the chat session containing that message
   - **Expected**: The message appears at the beginning of the conversation, not at the current time
3. Verify other messages in the same session maintain correct ordering
   - **Expected**: Only the invalid-timestamp message is affected; all others are in correct order
4. Check the browser console for timestamp-related warnings
   - **Expected**: No unhandled errors; graceful fallback behavior

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Consistent Format Across Components (Maps to AC-4)

1. Open a session that contains agent messages, user messages, and (if available) operator messages
2. Compare the timestamp format on agent messages (from `AgentMessage` component)
   - **Expected**: Uses `formatMessageTimestamp()` format
3. Compare the timestamp format on user messages (from `UserMessage` component)
   - **Expected**: Same format as agent messages
4. Compare operator messages (from `OperatorMessage` component), if present
   - **Expected**: Same format as agent and user messages
5. Verify no component uses `toLocaleTimeString()` inline formatting
   - **Expected**: All timestamps are consistently formatted

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: New Message Ordering Regression (Maps to AC-5)

1. Open an existing chat session
2. Send a new message (e.g., "Hello")
3. Observe where the new message appears
   - **Expected**: New message appears at the very bottom of the thread
4. Observe the timestamp on the new message
   - **Expected**: Shows current time in the standard format (e.g., "2:30 PM" for today)
5. Send another message immediately after
   - **Expected**: Second message appears below the first, in correct order

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000` (development) or staging URL
- **Branch**: `main` (commits `004d977`, `d7185ae`, `2001599`)
- **Setup**: `npm install && npm run dev`

### Test Data

- Chat session with messages spanning multiple days (ideally 3+ days of history)
- Session with both agent and user messages for format consistency testing
- For invalid timestamp testing: Optionally modify a message's `created_at` to an invalid value in Supabase

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure MCP servers are configured (Avinode, Supabase)
3. Have at least one chat session with multi-day message history
4. Optionally run unit tests to verify: `npx vitest run __tests__/unit/lib/utils/format`

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-190` on 2026-02-08*
