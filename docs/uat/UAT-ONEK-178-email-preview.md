# UAT Instructions: ONEK-178

**Issue**: [ONEK-178](https://linear.app/designthru-ai/issue/ONEK-178) ENHANCEMENT: Add proposal + email preview before sending to client
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-178-enhancement-add-proposal-email-preview-before-sending-to` (merged to `main`)
**Status**: Done
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This enhancement adds a mandatory preview step before sending proposals to clients. Users can review both the client-facing proposal and the exact outbound email content (recipients, subject, rendered body) before sending. The implementation ensures that the sent content matches exactly what was previewed, and that changes to the proposal after previewing require a re-preview before sending. Related bug fixes addressed a date off-by-one error and raw HTML rendering in the email preview.

---

## Acceptance Criteria

### AC-1: Proposal Preview Matches Client-Facing View

**Given** a user has generated a proposal and is ready to send it
**When** the user opens the proposal preview
**Then** the preview matches the client-facing view exactly, contains no internal-only fields (service charge breakdown, operator cost), and shows only the total cost and flight details

### AC-2: Email Preview Shows Exact Outbound Content

**Given** a user has generated a proposal and opens the email preview
**When** the email preview is displayed
**Then** the preview shows the exact recipients (To, CC), subject line, and fully rendered email body that the client will receive, with no raw HTML tags visible

### AC-3: Send Delivers Exactly What Was Previewed

**Given** a user has reviewed both the proposal and email previews
**When** the user clicks the send/approve button from the preview step
**Then** the email sent to the client contains exactly the content shown in the preview, with no modifications or template drift

### AC-4: Post-Preview Changes Require Re-Preview

**Given** a user has previewed a proposal and email
**When** the user makes changes to the proposal (e.g., modifies margin, updates flight details) after previewing
**Then** the system blocks sending until the user re-previews the updated content, ensuring version consistency

### AC-5: Email Preview Date Accuracy (Regression)

**Given** a proposal with a flight date of March 15, 2026
**When** the email preview renders the flight date
**Then** the date displayed is exactly "March 15, 2026" with no off-by-one error (not March 14 or March 16)

### AC-6: Regression -- Preview Step Is Mandatory

**Given** a proposal is ready to send
**When** the user attempts to skip the preview step
**Then** the system requires preview before allowing send

---

## Test Steps

### Test 1: Proposal Preview Content Verification (Maps to AC-1)

1. Open the app and start a flight request workflow or use an existing trip with quotes
2. Select a quote and begin proposal generation with a 10% margin
3. When the proposal preview step appears, review the content
   - **Expected**: The preview shows flight details (route, date, aircraft, operator) and total cost only
4. Verify no internal fields are visible
   - **Expected**: "Operator Cost", "Service Cost", "Jetvision Service Fee" are NOT shown in the preview
5. Compare the preview with the downloadable PDF (if available)
   - **Expected**: Both show identical content

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Email Preview Content Verification (Maps to AC-2)

1. After generating the proposal, navigate to the email preview step
2. Verify the recipient field
   - **Expected**: Shows the client's email address in the "To" field
3. Verify the subject line
   - **Expected**: Contains a professional subject line referencing the flight or proposal
4. Verify the email body
   - **Expected**: Rendered HTML email body with formatted text and flight details
5. Check for raw HTML tags in the body
   - **Expected**: No raw HTML tags visible (no `<p>`, `<div>`, `<br>` shown as text)

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Send Matches Preview (Maps to AC-3)

1. Complete the preview step and confirm the email content looks correct
2. Click the "Send" or "Approve & Send" button
   - **Expected**: The email is sent successfully with a confirmation message
3. Check the sent email (via Gmail or email logs)
   - **Expected**: Recipients, subject, and body match exactly what was shown in the preview
4. Verify any attached proposal PDF matches the previewed proposal content
   - **Expected**: Attached PDF matches the previewed content

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Version Mismatch Blocks Send (Maps to AC-4)

1. Generate a proposal and open the email preview
2. Before sending, go back and modify the margin percentage (e.g., change from 10% to 15%)
3. Attempt to send the email with the outdated preview
   - **Expected**: The system prevents sending and prompts re-preview
4. Re-preview the proposal with the new margin
   - **Expected**: The preview updates to reflect the 15% margin and new total cost
5. Send the email from the updated preview
   - **Expected**: Email sends successfully with the updated content

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: Flight Date Accuracy in Email (Maps to AC-5)

1. Create a flight request with a specific date (e.g., "March 15, 2026")
2. Generate a proposal and open the email preview
3. Verify the flight date in the email preview
   - **Expected**: Date shows "March 15, 2026" with no off-by-one error
4. Send the email and verify the date in the received email
   - **Expected**: Date matches the original request date exactly

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 6: Preview Is Mandatory (Maps to AC-6)

1. Generate a proposal
2. Look for a direct "Send" button that bypasses preview
   - **Expected**: No way to send without previewing first; the flow enforces preview before send

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000` (development) or staging URL
- **Branch**: `main` (commits `d3de259`, `823d55b`, `34695f0`)
- **Setup**: `npm install && npm run dev`

### Test Data

- Use a chat session with active trip and received quotes
- Have a test customer with a valid email address in the CRM
- Recommended: Use a personal email as the recipient to verify sent content
- Flight dates to test: Use future dates for date accuracy (e.g., March 15, 2026)

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure Gmail MCP server is configured for email sending
3. Ensure at least one active trip with quotes exists
4. Confirm test customer has a valid email address

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-178` on 2026-02-08*
