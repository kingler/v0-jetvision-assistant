# UAT Instructions: ONEK-175

**Issue**: [ONEK-175](https://linear.app/designthru-ai/issue/ONEK-175) BUG: RFQ price updates by operator do not refresh in Chat UI
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-175-bug-rfq-price-updates-by-operator-do-not-refresh-in-chat-ui` (merged to `main` via PR #94)
**Status**: Done
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This bug fix resolves an issue where operator-updated RFQ prices were not reflected in the chat UI. Users were seeing stale pricing, creating a mismatch between operator-confirmed terms and what the buyer saw. The fix ensures that when a user refreshes the RFQ data (by asking the agent to check status or triggering a refresh), the chat UI displays the latest operator-updated price. Additional webhook bugs discovered during E2E testing were also resolved in this fix.

---

## Acceptance Criteria

### AC-1: Updated Price Shown After RFQ Refresh

**Given** an operator has updated the RFQ price in Avinode
**When** the user refreshes the RFQ data (asks "check RFQ status" or triggers a refresh action)
**Then** the chat UI displays the updated price from the operator, not the original stale price

### AC-2: Quote Card Reflects Current Price

**Given** the RFQ price has been updated by the operator
**When** the user views the quote card in the chat thread after refreshing
**Then** the quote card shows the latest price amount, aircraft details, and operator name from the updated quote

### AC-3: Webhook Events Process Updated Quotes

**Given** an operator sends an updated quote via the Avinode webhook (`TripRequestSellerResponse`)
**When** the webhook event is received and processed
**Then** the updated quote data is stored in the database and available for display when the user next checks

### AC-4: Regression -- Initial Quote Display Unchanged

**Given** a new RFQ quote arrives via webhook for the first time
**When** the quote card is first displayed in the chat
**Then** the initial price is shown correctly, identical to behavior before this fix

---

## Test Steps

### Test 1: Price Refresh After Operator Update (Maps to AC-1, AC-2)

1. Open a chat session with an active trip that has received operator quotes
2. Note the current price shown on the quote card(s)
3. Have the operator update the price in Avinode (or simulate via webhook test endpoint)
4. In the chat, ask: "Check the status of the RFQs"
5. Wait for the agent to retrieve and display updated RFQ data
   - **Expected**: Quote card(s) now show the updated price from the operator
   - **Expected**: The old/stale price is no longer visible on the updated card
6. Verify the price amount matches the operator's update
   - **Expected**: Dollar amount, currency, and any quote details reflect the operator's latest submission

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Webhook Processing of Updated Quotes (Maps to AC-3)

1. Verify the webhook endpoint is configured and receiving events
2. Trigger or wait for a `TripRequestSellerResponse` webhook event with an updated price
3. Check the `avinode_webhook_events` table in Supabase
   - **Expected**: The updated quote event is stored with the new price data
4. In the chat, ask "Check RFQ status"
   - **Expected**: The agent retrieves and displays the latest quote with updated pricing

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Initial Quote Display Regression (Maps to AC-4)

1. Create a new trip and send RFPs to operators
2. Wait for an operator to respond with a first-time quote
3. Observe the quote card in the chat
   - **Expected**: Quote card appears with the correct initial price, aircraft, and operator details
4. Verify no duplicate or ghost cards appear
   - **Expected**: Only one card per operator quote

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Multiple Price Updates in Sequence

1. Start with a trip that has received an initial quote
2. Have the operator update the price a first time
3. Refresh RFQs in the chat
   - **Expected**: First update is reflected
4. Have the operator update the price a second time
5. Refresh RFQs again
   - **Expected**: Second update is reflected, showing only the most recent price

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000` (development) or staging URL
- **Branch**: `main` (commits `0782a6a`, `b222f48`)
- **Setup**: `npm install && npm run dev`

### Test Data

- Active trip with at least one operator quote received
- Ability to trigger operator price updates (via Avinode or webhook simulation)
- Access to Supabase dashboard to verify `avinode_webhook_events` table

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure Avinode MCP server is configured with valid API token
3. Ensure webhook endpoint (`/api/webhooks/avinode`) is active and receiving events
4. Have an active trip with at least one operator response

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-175` on 2026-02-08*
