# UAT Instructions: ONEK-184

**Issue**: [ONEK-184](https://linear.app/designthru-ai/issue/ONEK-184) Implement Working Memory for Cross-Turn Trip/Entity Retention
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-184-implement-working-memory-for-cross-turn-tripentity-retention` (merged to `main`)
**Status**: Done
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This feature implements a structured working memory system for the JetvisionAgent that reliably retains entity IDs (tripId, rfqId, clientId, etc.) across conversation turns. Previously, the agent relied on parsing IDs from its own prior text output, which was unreliable in long conversations. The new system loads entity state from the `requests.workflow_state` JSONB column at each turn, injects a "Current Session Context" block into the system prompt, extracts updates from tool results (e.g., `create_trip`, `get_rfq`, `get_client`), and persists changes back to the database.

---

## Acceptance Criteria

### AC-1: Cross-Turn Trip ID Retention

**Given** a user has created a trip in a previous conversation turn (e.g., "I need a flight from KTEB to KVNY")
**When** the user asks about that trip in a subsequent turn (e.g., "Check the status of the RFQs") without mentioning the trip ID
**Then** the agent successfully retrieves the trip and RFQ information using the stored tripId from working memory

### AC-2: Working Memory Auto-Extraction from Tool Results

**Given** the agent executes a tool that returns entity data (e.g., `create_trip` returns a tripId and deepLink)
**When** the tool result is processed
**Then** the working memory is automatically updated with the extracted entity IDs, and subsequent turns can reference these IDs without re-parsing

### AC-3: Working Memory Persistence Across Page Reloads

**Given** a user has an active conversation with entities stored in working memory
**When** the user refreshes the browser or returns to the session later
**Then** the working memory is reloaded from the database (`requests.workflow_state`), and the agent references all previously stored entities without loss

### AC-4: Client Info Retention Across Turns

**Given** the user has selected a client during the proposal workflow
**When** the user asks "Send the proposal to the client" without re-specifying the client
**Then** the agent uses the stored client name and email from working memory to send the proposal

### AC-5: New Sessions Start with Empty Memory (Regression)

**Given** the user opens a brand new chat session
**When** the user sends the first message
**Then** working memory is empty with no stale data from other sessions

---

## Test Steps

### Test 1: Cross-Turn Trip Recall (Maps to AC-1)

1. Open the app and start a new chat session
2. Submit a flight request: "I need a flight from Teterboro to Van Nuys on March 20"
3. Wait for the agent to call `create_trip` and return a trip summary
4. Note the trip ID displayed in the response
5. In the SAME session, type: "Check the status of the RFQs"
   - **Expected**: The agent retrieves RFQ information for the trip created in step 2 without asking "Which trip?" or failing to find the trip
6. Type: "What is my trip ID?"
   - **Expected**: The agent responds with the correct trip ID from working memory

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Auto-Extraction from Tool Results (Maps to AC-2)

1. Start a new chat session
2. Submit: "Search for a flight from KLAX to KORD on April 5 for 4 passengers"
3. Wait for the `create_trip` tool to execute
   - **Expected**: The agent response includes trip details with a trip ID
4. Submit: "Get the RFQ details"
   - **Expected**: The agent uses the auto-extracted tripId to call `get_rfq` successfully without asking for the trip ID
5. Submit: "Who is the client for this request?"
   - **Expected**: If a client was set, the agent references the clientId, clientName, and clientEmail from working memory

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Persistence Across Reloads (Maps to AC-3)

1. Complete a trip creation in a chat session (as in Test 1, steps 1-3)
2. Note the trip ID
3. Refresh the browser (Cmd+R / Ctrl+R)
4. Navigate back to the same chat session
5. Type: "What trip are we working on?"
   - **Expected**: The agent recalls the trip ID and associated details from the reloaded working memory
6. Type: "Check the RFQ status"
   - **Expected**: The agent successfully queries using the persisted tripId

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Client Info Retention (Maps to AC-4)

1. In a session with a created trip, proceed to proposal generation
2. Select a client (e.g., "Send it to John Smith at john@example.com")
3. Later in the conversation, say: "Send the proposal"
   - **Expected**: Agent uses the previously selected client without asking again
4. Verify by checking the email preview that shows the stored client email

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: New Session Has Clean Memory (Maps to AC-5)

1. Open a brand new chat session (not an existing one)
2. Send: "Check the status of the RFQs"
   - **Expected**: Agent asks for trip details since no trip has been created in this session
3. Verify no stale entity IDs from other sessions appear in the response

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: `http://localhost:3000` (development) or staging URL
- **Branch**: `main` (referenced commit `b371591` per issue description)
- **Setup**: `npm install && npm run dev`

### Test Data

- Use new chat sessions to start with clean working memory state
- Recommended airports: KTEB, KVNY, KLAX, KORD
- For persistence testing, note the session ID to return after browser refresh

### Pre-Test Setup

1. Ensure all dependencies are installed: `npm install`
2. Ensure MCP servers are configured (Avinode, Supabase)
3. Optionally verify access to Supabase dashboard to inspect `requests.workflow_state` column

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed -- ready for production
- [ ] Issues found -- see notes above
- [ ] Blocked -- requires {description}

---

*Generated by `/uat_instructions ONEK-184` on 2026-02-08*
