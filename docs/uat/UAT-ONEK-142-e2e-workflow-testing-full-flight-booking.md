# UAT Instructions: ONEK-142

**Issue**: [ONEK-142] E2E Workflow Testing - Full Flight Booking Flow
**Date Generated**: 2026-02-08
**Branch**: `kinglerbercy/onek-142-e2e-workflow-testing-full-flight-booking-flow`
**Status**: In Progress
**Priority**: High
**Author**: Generated by Claude Code `/uat_instructions`

---

## Overview

This issue creates end-to-end test coverage for the complete charter flight booking workflow — from flight request through trip creation, quote reception via webhooks, operator messaging, proposal generation with PDF, email sending, and booking confirmation. Currently, unit and integration tests exist for individual components, but no E2E tests cover the full workflow chain. The deliverables include 4 test files, 2 fixture files, 2 mock files, and test infrastructure updates to `vitest.config.ts` and `package.json`.

---

## Acceptance Criteria

### AC-1: E2E Test for Trip Creation Flow

**Given** the E2E test infrastructure is configured (`vitest.config.e2e.ts`, fixtures, mocks)
**When** the `booking-workflow.test.ts` E2E test suite runs via `npm run test:e2e`
**Then** the "Flight Request to Trip Creation" tests pass — verifying that a chat flight request triggers `create_trip`, saves to the database, and returns a deep link in the UI

### AC-2: E2E Test for Quote-to-Proposal Pipeline

**Given** mock webhook payloads exist in `__tests__/fixtures/webhook-payloads.ts`
**When** the `proposal-generation.test.ts` E2E test suite runs
**Then** tests pass verifying: (1) `TripRequestSellerResponse` webhook stores quote in database and emits SSE event, (2) "Generate Proposal" produces a PDF, (3) proposal email sends via Gmail MCP with PDF attachment

### AC-3: E2E Test for Operator Messaging

**Given** mock Avinode API responses are configured in `__tests__/mocks/avinode-api.ts`
**When** the `operator-messaging.test.ts` E2E test suite runs
**Then** tests pass verifying: (1) user can send a message to an operator via `send_trip_message`, (2) inbound `TripChatFromSeller` webhook stores the message, (3) message thread displays in correct chronological order

### AC-4: E2E Test for Booking Confirmation and Quote Decline

**Given** mock booking data exists in `__tests__/fixtures/booking-data.ts`
**When** the `booking-workflow.test.ts` and `quote-decline.test.ts` E2E suites run
**Then** tests pass verifying: (1) booking modal opens with quote details, (2) customer/passenger info collection works, (3) booking submission calls the correct tool, (4) `BookingConfirmed` webhook updates status, (5) quote decline with reason updates the database

### AC-5: Test Infrastructure and Scripts Configured

**Given** the E2E test infrastructure changes are in place
**When** `npm run test:e2e` is executed from the command line
**Then** the E2E test runner uses the dedicated `vitest.config.e2e.ts` with 30-second timeout, loads the E2E setup file, and reports results for all E2E test files

### AC-6: Existing Unit and Integration Tests Unaffected (Regression)

**Given** the new E2E test configuration and files are added
**When** `npm run test:unit` and `npm run test:integration` are executed
**Then** all existing unit and integration tests pass with no changes to their results or coverage metrics

---

## Test Steps

### Test 1: Trip Creation E2E (Maps to AC-1)

1. Ensure the E2E test files exist:
   - `__tests__/e2e/booking-workflow.test.ts`
   - `__tests__/fixtures/booking-data.ts`
   - `__tests__/mocks/avinode-api.ts`
   - **Expected**: All files exist with test cases
2. Run the trip creation tests: `npm run test:e2e -- --grep "Flight Request to Trip Creation"`
   - **Expected**: Tests pass — `create_trip` called, trip saved to DB mock, deep link returned
3. Verify the test uses proper mocks (no real API calls)
   - **Expected**: Avinode API mock intercepts all outbound requests

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 2: Quote-to-Proposal E2E (Maps to AC-2)

1. Verify fixture file exists: `__tests__/fixtures/webhook-payloads.ts`
   - **Expected**: Contains `mockTripRequestSellerResponse` with realistic payload
2. Run proposal tests: `npm run test:e2e -- --grep "Quote to Proposal"`
   - **Expected**: Webhook handling test passes (quote stored, SSE emitted)
   - **Expected**: PDF generation test passes
   - **Expected**: Email sending test passes (Gmail MCP mock used)
3. Verify the Gmail MCP mock exists: `__tests__/mocks/gmail-mcp.ts`
   - **Expected**: Mock intercepts `sendEmail` calls and records arguments

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 3: Operator Messaging E2E (Maps to AC-3)

1. Run messaging tests: `npm run test:e2e -- --grep "Operator Messaging"`
   - **Expected**: Send message test passes (`send_trip_message` called with correct args)
   - **Expected**: Receive message test passes (webhook processed, message stored)
   - **Expected**: Thread display test passes (messages in chronological order)

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 4: Booking and Decline E2E (Maps to AC-4)

1. Run booking tests: `npm run test:e2e -- --grep "Booking Flow"`
   - **Expected**: Modal opens with correct quote data
   - **Expected**: Customer info collection works
   - **Expected**: Booking submission calls correct tool
2. Run decline tests: `npm run test:e2e -- --grep "Quote Decline"`
   - **Expected**: Decline modal opens, reason submitted, database updated

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 5: Test Infrastructure (Maps to AC-5)

1. Verify `package.json` has the `test:e2e` script
   - **Expected**: `"test:e2e"` script exists and references E2E config
2. Run the full E2E suite: `npm run test:e2e`
   - **Expected**: All E2E tests run with 30-second timeout, all pass
3. Verify test output shows distinct E2E test grouping
   - **Expected**: Tests grouped under `__tests__/e2e/` prefix

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

### Test 6: Unit/Integration Regression (Maps to AC-6)

1. Run existing unit tests: `npm run test:unit`
   - **Expected**: All unit tests pass — no regressions
2. Run existing integration tests: `npm run test:integration`
   - **Expected**: All integration tests pass — no regressions
3. Run coverage: `npm run test:coverage`
   - **Expected**: Coverage meets or exceeds 75% threshold

**Result**: [ ] Pass  [ ] Fail

**Notes**: _______________

---

## Test Data & Environment

### Environment Requirements

- **URL**: N/A (tests run in Node.js via Vitest)
- **Branch**: `kinglerbercy/onek-142-e2e-workflow-testing-full-flight-booking-flow`
- **Setup**: `npm install` then `npm run test:e2e`

### Test Data

- Mock webhook payloads in `__tests__/fixtures/webhook-payloads.ts`
- Mock customer/passenger data in `__tests__/fixtures/booking-data.ts`
- Mock Avinode API in `__tests__/mocks/avinode-api.ts`
- Mock Gmail MCP in `__tests__/mocks/gmail-mcp.ts`

### Pre-Test Setup

1. Install dependencies: `npm install`
2. Ensure no conflicting test processes running
3. No real API credentials needed — all tests use mocks

---

## Sign-Off

| Tester | Role | Result | Date | Signature |
|--------|------|--------|------|-----------|
| @AB | QA Lead | [ ] Pass [ ] Fail | ____-__-__ | _________ |
| @Kham | Developer | [ ] Pass [ ] Fail | ____-__-__ | _________ |

### Final Disposition

- [ ] All tests passed — ready for production
- [ ] Issues found — see notes above
- [ ] Blocked — requires {description}

---

*Generated by `/uat_instructions ONEK-142` on 2026-02-08*
